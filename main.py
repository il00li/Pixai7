import telebot
import requests
import json
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
from flask import Flask, request
import threading
import time

# ØªÙƒÙˆÙŠÙ† Ø§Ù„ØªÙˆÙƒÙ†Ø§Øª ÙˆØ§Ù„Ù…ÙØ§ØªÙŠØ­
TOKEN = "8299954739:AAHlkfRH4N0cDjv-IToJkXQwwIqYCtzcVCQ"
ADMIN_ID = 7251748706
MANDATORY_CHANNELS = ["@crazys7", "@AWU87"]
WEBHOOK_URL = "https://pixai7.onrender.com/" + TOKEN
GROQ_API_KEY = "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"  # Ø§Ø³ØªØ¨Ø¯Ù„ Ø¨Ù…ÙØªØ§Ø­ Groq Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª
bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
subscribed_users = set()

# ÙˆØ¸ÙŠÙØ© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
def keep_alive():
    while True:
        time.sleep(300)
        try:
            requests.get(WEBHOOK_URL)
        except: 
            pass

# ÙˆØ¸ÙŠÙØ© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª
def check_subscription(user_id):
    try:
        for channel in MANDATORY_CHANNELS:
            member = bot.get_chat_member(chat_id=channel, user_id=user_id)
            if member.status not in ['member', 'administrator', 'creator']:
                return False
        return True
    except Exception as e:
        print(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {e}")
        return False

# Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ù…ÙØ§ØªÙŠØ­ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¥Ø¬Ø¨Ø§Ø±ÙŠ
def subscription_keyboard():
    markup = InlineKeyboardMarkup()
    for channel in MANDATORY_CHANNELS:
        markup.add(InlineKeyboardButton(f"Ø§Ø´ØªØ±Ùƒ ÙÙŠ {channel}", url=f"https://t.me/{channel[1:]}"))
    markup.add(InlineKeyboardButton("âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ", callback_data="check_subscription"))
    return markup

# ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Llama 3
def get_ai_response(prompt):
    headers = {
        "Authorization": f"Bearer {GROQ_API_KEY}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "messages": [
            {"role": "system", "content": "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ ÙŠØªØ­Ø¯Ø« Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø·Ù„Ø§Ù‚Ø©."},
            {"role": "user", "content": prompt}
        ],
        "model": "llama3-70b-8192",
        "temperature": 0.7,
        "max_tokens": 2000,
        "top_p": 1,
        "stream": False
    }
    
    try:
        response = requests.post(
            "https://api.groq.com/openai/v1/chat/completions",
            headers=headers,
            json=payload,
            timeout=60
        )
        
        if response.status_code == 200:
            return response.json()["choices"][0]["message"]["content"]
        else:
            return f"âŒ Ø®Ø·Ø£ ÙÙŠ API: {response.status_code} - {response.text}"
            
    except Exception as e:
        return f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: {str(e)}"

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù…Ø± /start
@bot.message_handler(commands=['start'])
def start_command(message):
    user_id = message.from_user.id
    if check_subscription(user_id):
        bot.reply_to(message, "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø¨ÙˆØª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø´Ø§Ø¨Ù‡ Ù„Ù€ ChatGPT.\nØ§Ø·Ø±Ø­ Ø¹Ù„ÙŠ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ÙˆØ³Ø£Ø¬ÙŠØ¨Ùƒ Ø¨Ø°ÙƒØ§Ø¡!")
        subscribed_users.add(user_id)
        bot.send_message(ADMIN_ID, f"âœ… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù…:\nID: {user_id}\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…: @{message.from_user.username}")
    else:
        bot.send_message(
            message.chat.id,
            "ğŸ“¢ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹:",
            reply_markup=subscription_keyboard()
        )

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
@bot.callback_query_handler(func=lambda call: call.data == "check_subscription")
def check_subscription_callback(call):
    user_id = call.from_user.id
    if check_subscription(user_id):
        bot.edit_message_text(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            text="âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª."
        )
        subscribed_users.add(user_id)
        bot.send_message(ADMIN_ID, f"âœ… Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø£ÙƒØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:\nID: {user_id}\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…: @{call.from_user.username}")
    else:
        bot.answer_callback_query(call.id, "âŒ Ù„Ù… ØªØ´ØªØ±Ùƒ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!", show_alert=True)

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ©
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    user_id = message.from_user.id
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
    if user_id not in subscribed_users:
        if check_subscription(user_id):
            subscribed_users.add(user_id)
        else:
            bot.send_message(
                message.chat.id,
                "â›” ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ø£ÙˆÙ„Ø§Ù‹:",
                reply_markup=subscription_keyboard()
            )
            return
    
    # Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù† Ø§Ù„Ø¨ÙˆØª ÙŠÙƒØªØ¨
    bot.send_chat_action(message.chat.id, 'typing')
    
    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    response = get_ai_response(message.text)
    bot.reply_to(message, response)

# ØªÙ‡ÙŠØ¦Ø© ÙˆÙŠØ¨ Ù‡ÙˆÙˆÙƒ
@app.route('/' + TOKEN, methods=['POST'])
def webhook():
    if request.headers.get('content-type') == 'application/json':
        json_string = request.get_data().decode('utf-8')
        update = telebot.types.Update.de_json(json_string)
        bot.process_new_updates([update])
        return ''
    return 'Invalid content type', 403

@app.route('/')
def index():
    return 'ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!', 200

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
if __name__ == '__main__':
    # Ø¥Ø²Ø§Ù„Ø© ÙˆÙŠØ¨ Ù‡ÙˆÙˆÙƒØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    bot.remove_webhook()
    time.sleep(1)
    
    # ØªØ¹ÙŠÙŠÙ† ÙˆÙŠØ¨ Ù‡ÙˆÙˆÙƒ Ø¬Ø¯ÙŠØ¯
    bot.set_webhook(url=WEBHOOK_URL)
    
    # Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø·
    threading.Thread(target=keep_alive).start()
    
    # Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø§Ø¯Ù…
    app.run(host='0.0.0.0', port=8080)
